<!doctype html>
<html lang="mr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>आजचा पंचांग — OmKarmyog</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&family=Baloo+2:wght@700&display=swap" rel="stylesheet">

  <style>
    body{margin:0;padding:18px;background:#f3f4f6;font-family:'Noto Sans Devanagari',sans-serif;}
    .wrap{max-width:960px;margin:auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08)}
    h1{font-family:'Baloo 2';margin:0;font-size:24px}
    label{display:block;margin-top:16px;font-weight:600}
    select,input,button{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-top:6px;font-size:16px}
    button{border:0;color:#fff;cursor:pointer}
    .btn1{background:#012b46}
    .btn2{background:#d97706}
    #preview{margin-top:18px;width:100%;border-radius:10px;border:1px solid #eee;display:block}
  </style>
</head>
<body>

<div class="wrap">
  <h1>आजचा पंचांग — OmKarmyog</h1>

  <label>शहर</label>
  <select id="city">
      <option>Mumbai</option>
      <option>Pune</option>
      <option>Nagpur</option>
      <option>Aurangabad</option>
  </select>

  <label>नाव</label>
  <input id="username" placeholder="उदा. संकेत रामदासी"/>

  <label>संपर्क</label>
  <input id="mobile" placeholder="उदा. 98XXXXXXXX"/>

  <label>फोटो (ऐच्छिक)</label>
  <input type="file" id="userPhoto" accept="image/*"/>

  <button class="btn1" id="generateBtn">Generate Card</button>
  <button class="btn2" id="downloadBtn" style="margin-top:8px">Download PNG</button>

  <canvas id="canvas" width="1080" height="1316" style="display:none"></canvas>
  <img id="preview"/>
</div>

<script>
const el=id=>document.getElementById(id);
const logoUrl="https://blogger.googleusercontent.com/img/a/AVvXsEi1b1z9W0Emd6TROMLNG0AHDbF9oFVx3hrQWAA5sPXU0H0GutM8nlVBGpbcS_YI59L5xehYJefv6C5vvyDOOUZ6PyzvktW_48aSgPjM7JxL_1a5oxKz2T6_cH8xDzqVwg7uhwklag6Vs-U1NiMq06Tq3Wn8JItmyboW9Wz_drK9NP_lOhDq2IjnSlE8Fe6F=s975";

function todayISO(){
    const d=new Date();
    const y=d.getFullYear();
    const m=("0"+(d.getMonth()+1)).slice(-2);
    const dd=("0"+d.getDate()).slice(-2);
    return `${y}-${m}-${dd}`;
}

async function loadJSON(){
  const url="https://www.omkarmyog.in/p/secret-panchang-ganarator-file-no-public.html";
  const html=await fetch(url).then(r=>r.text());
  const m=html.match(/<script[^>]*type="application\/json"[^>]*>([\s\S]*?)<\/script>/i);
  if(!m) return null;
  return JSON.parse(m[1].trim());
}

function drawIcon(ctx,x,y,g){
  ctx.save();
  ctx.fillStyle="#f9c846";
  ctx.beginPath(); ctx.arc(x,y,22,0,Math.PI*2); ctx.fill();
  ctx.fillStyle="#fff";
  ctx.font="18px Noto Sans Devanagari";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(g,x,y);
  ctx.restore();
}

function wrapRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}

let userPhotoData = null;
el("userPhoto").addEventListener("change", e => {
  const f=e.target.files[0];
  if(!f){ userPhotoData=null; return; }
  const r=new FileReader();
  r.onload=()=>userPhotoData=r.result;
  r.readAsDataURL(f);
});

async function generate(){
  const city=el("city").value;
  const date=todayISO();
  const name=el("username").value||"";
  const mobile=el("mobile").value||"";

  const data=await loadJSON();
  if(!data || !data[date]){
    alert("आजचा पंचांग उपलब्ध नाही.");
    return;
  }

  const p=data[date];

  const c=el("canvas");
  const ctx=c.getContext("2d");

  ctx.fillStyle="#fffaf3";
  ctx.fillRect(0,0,c.width,c.height);

  // watermark
  try{
    const wm=new Image();
    wm.crossOrigin="anonymous";
    wm.src=logoUrl;
    await new Promise(res=>wm.onload=res);
    ctx.save();
    ctx.globalAlpha=0.10;
    let sc=Math.min(c.width*0.7/wm.width, c.height*0.7/wm.height);
    let w=wm.width*sc, h=wm.height*sc;
    ctx.drawImage(wm, c.width/2-w/2, 220, w, h);
    ctx.restore();
  }catch{}

  // header
  ctx.fillStyle="#012b46";
  ctx.fillRect(0,0,c.width,120);
  ctx.fillStyle="#fff";
  ctx.font="bold 56px Baloo 2";
  ctx.fillText("आजचा पंचांग",48,78);

  // logo
  try{
    const lg=new Image();
    lg.src=logoUrl;
    await new Promise(r=>lg.onload=r);
    ctx.drawImage(lg, c.width-200, 20, 160, 64);
  }catch{}

  // date
  const dt=new Date();
  const dtText=dt.toLocaleDateString('mr-IN',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  ctx.font="20px Noto Sans Devanagari";
  ctx.fillText(dtText, c.width-460, 40);

  // box
  const boxX=48, boxY=150, boxW=c.width-96;
  ctx.strokeStyle="#c86d22"; ctx.lineWidth=5;
  wrapRect(ctx, boxX, boxY, boxW, 520, 12);
  ctx.stroke();

  ctx.font="28px Noto Sans Devanagari";
  ctx.fillStyle="#0b2b3a";

  let y=boxY+60;
  const gap=58;
  const textX = boxX + 90;

  drawIcon(ctx, boxX+36, y-10, "ति");
  ctx.fillText(`तिथी: ${p.tithi}${p.tithi_end?(" • समाप्ती: "+p.tithi_end):""}`, textX,y); 
  y+=gap;

  drawIcon(ctx, boxX+36, y-10, "वा");
  ctx.fillText(`वार: ${dt.toLocaleDateString("mr-IN",{weekday:"long"})}`, textX,y);
  y+=gap;

  drawIcon(ctx, boxX+36, y-10, "न");
  ctx.fillText(`नक्षत्र: ${p.nakshatra}${p.nak_end?(" • समाप्ती: "+p.nak_end):""}`, textX,y); 
  y+=gap;

  drawIcon(ctx, boxX+36, y-10, "यो");
  ctx.fillText(`योग: ${p.yog}`, textX,y); 
  y+=gap;

  drawIcon(ctx, boxX+36, y-10, "क");
  ctx.fillText(`करण: ${p.karan}${p.karan_end?(" • समाप्ती: "+p.karan_end):""}`, textX,y); 

  // right column
  let y2=boxY+60;
  const col2X = boxX + boxW/2 + 20;
  ctx.font="26px Noto Sans Devanagari";

  ctx.fillText(`सूर्योदय: ${p.sunrise}    सूर्यास्त: ${p.sunset}`, col2X, y2); y2+=48;
  ctx.fillText(`चंद्रराशी: ${p.moon_rashi}`, col2X, y2); y2+=48;
  ctx.fillText(`सूर्यराशी: ${p.sun_rashi}`, col2X, y2); y2+=48;
  ctx.fillText(`गुरुराशी: ${p.guru_rashi}`, col2X, y2); y2+=48;
  ctx.fillText(`राहू काल: ${p.rahu}`, col2X, y2);

  // din-vishesh
  if(p.din_vishesh){
    ctx.fillStyle="#fff3d6";
    ctx.fillRect(boxX, boxY+520+8, boxW, 72);
    ctx.fillStyle="#0b2b3a";
    ctx.font="22px Noto Sans Devanagari";
    ctx.fillText(`दिनविशेष: ${p.din_vishesh}`, boxX+18, boxY+520+48);
  }

  // bottom strip
  const stripY=boxY+620;
  ctx.fillStyle="#083b52";
  ctx.fillRect(0, stripY, c.width, 140);

  ctx.fillStyle="#fff";
  ctx.font="bold 34px Noto Sans Devanagari";
  ctx.fillText(name,48, stripY+48);

  ctx.font="22px Noto Sans Devanagari";
  ctx.fillText(`संपर्क: ${mobile}`,48, stripY+88);

  // user photo
  if(userPhotoData){
    const img2=new Image();
    img2.src=userPhotoData;
    img2.onload=()=>{
      ctx.save();
      ctx.beginPath();
      ctx.arc(c.width-120, stripY+70, 56, 0, Math.PI*2);
      ctx.clip();
      ctx.drawImage(img2, c.width-176, stripY+14, 112,112);
      ctx.restore();
      finalize();
    };
    img2.onerror=finalize;
  } else finalize();

  function finalize(){
    el("preview").src = c.toDataURL("image/png");
  }
}

el("generateBtn").addEventListener("click", generate);

el("downloadBtn").addEventListener("click", ()=>{
  const a=document.createElement("a");
  a.href=el("canvas").toDataURL("image/png");
  a.download="panchang_1080x1316.png";
  a.click();
});

// auto-generate
window.onload=()=>setTimeout(()=>generate(),500);
</script>

</body>
</html>
