<!doctype html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>आजचा पंचांग — Generator (Offline)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;600&family=Baloo+2:wght@700&display=swap" rel="stylesheet">

<style>
  body { font-family: 'Noto Sans Devanagari', sans-serif; background:#f3f3e8; margin:0; padding:18px; }
  .wrap { max-width:940px; margin:auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 8px 26px rgba(0,0,0,.08); }
  h1{ font-family:'Baloo 2'; margin:0 0 8px 0; }
  label{display:block; margin-top:12px; font-weight:600}
  select,input{width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; font-size:16px}
  .row{display:flex; gap:12px}
  .col{flex:1}
  button{padding:12px 14px; border:0; border-radius:8px; color:#fff; cursor:pointer}
  #generateBtn{ background:#0b4a6f; width:100%; margin-top:14px }
  #downloadBtn{ background:#d97706; width:100%; margin-top:8px }
  #preview{ margin-top:18px; width:100%; border-radius:10px; border:1px solid #eee; display:block}
  .small{font-size:13px;color:#666;margin-top:8px}
  @media (max-width:720px){ .wrap{padding:12px} button{font-size:15px} }
</style>
</head>
<body>
<div class="wrap">
  <h1>आजचा पंचांग</h1>
  <div class="small">Offline calculation — no API needed. Host on GitHub Pages and use in your WebView app.</div>

  <div class="row" style="margin-top:14px">
    <div class="col">
      <label>शहर</label>
      <select id="city"><option>Mumbai</option><option>Pune</option><option>Nagpur</option><option>Aurangabad</option></select>
    </div>
    <div style="width:220px">
      <label>दिनांक</label>
      <input id="dateInput" type="date">
    </div>
  </div>

  <label>नाव</label>
  <input id="username" placeholder="उदा. संकेत रामदासी">

  <label>संपर्क</label>
  <input id="mobile" placeholder="उदा. 98XXXXXXXX">

  <label>फोटो (ऐच्छिक)</label>
  <input id="userPhoto" type="file" accept="image/*">

  <button id="generateBtn">Generate Panchang Card</button>
  <button id="downloadBtn">Download PNG</button>

  <canvas id="canvas" width="1080" height="1316" style="display:none"></canvas>
  <img id="preview" alt="Preview (1080x1316)">

  <div class="small">If preview is blank after publish, press Generate once. Then use the page URL in your WebView app.</div>
</div>

<script>
/* ---------- Utilities ---------- */
const toRad = deg => deg * Math.PI / 180;
const toDeg = rad => rad * 180 / Math.PI;
const norm = x => ((x % 360) + 360) % 360;

/* ---------- Julian Day ---------- */
function dateToJulianDate(d){
  // d: Date object in UTC
  let year = d.getUTCFullYear();
  let month = d.getUTCMonth() + 1;
  let day = d.getUTCDate() + (d.getUTCHours()/24) + (d.getUTCMinutes()/1440) + (d.getUTCSeconds()/86400);
  if(month <= 2){ month += 12; year -= 1; }
  const A = Math.floor(year/100);
  const B = 2 - A + Math.floor(A/4);
  const JD = Math.floor(365.25*(year+4716)) + Math.floor(30.6001*(month+1)) + day + B - 1524.5;
  return JD;
}

/* ---------- Sun longitude (approx) ---------- */
function sunEclipticLongitudeJDE(jd){
  const d = jd - 2451545.0;
  const M = norm(357.5291 + 0.98560028 * d);
  const L0 = norm(280.46646 + 0.98564736 * d);
  const C = 1.9148 * Math.sin(toRad(M)) + 0.0200 * Math.sin(toRad(2*M)) + 0.0003 * Math.sin(toRad(3*M));
  const trueLong = norm(L0 + C);
  return trueLong;
}

/* ---------- Moon longitude (approx) ---------- */
function moonEclipticLongitudeJDE(jd){
  const d = jd - 2451545.0;
  const Lm = norm(218.316 + 13.176396 * d);
  const Mm = norm(134.963 + 13.064993 * d);
  const Ms = norm(357.529 + 0.98560028 * d);
  const D = norm(297.850 + 12.190749 * d);
  const lon = Lm
    + 6.289 * Math.sin(toRad(Mm))
    + 1.274 * Math.sin(toRad(2*D - Mm))
    + 0.658 * Math.sin(toRad(2*D))
    + 0.214 * Math.sin(toRad(2*Mm))
    - 0.186 * Math.sin(toRad(Ms))
    - 0.059 * Math.sin(toRad(2*D - 2*Mm))
    - 0.057 * Math.sin(toRad(2*D - Ms - Mm));
  return norm(lon);
}

/* ---------- Tithi/Nakshatra/Yoga/Karan ---------- */
function computeTithi(sunLon, moonLon){
  const diff = norm(moonLon - sunLon);
  const idx = Math.floor(diff / 12); // 0..29
  return { index: idx + 1, nameIndex: idx };
}
const tithiNames = [
  'प्रतिपदा','द्वितीया','तृतीया','चतुर्थी','पंचमी','षष्ठी','सप्तमी','अष्टमी','नवमी','दशमी',
  'एकादशी','द्वादशी','त्रयोदशी','चतुर्दशी','पुनरारम्भ','पंचमी (दो)','षष्ठी (दो)','सप्तमी (दो)','अष्टमी (दो)','नवमी (दो)',
  'दशमी (दो)','एकादशी (दो)','द्वादशी (दो)','त्रयोदशी (दो)','चतुर्दशी (दो)','अन्य','अन्य','अन्य','अन्य','अन्य'
];

const nakshatraNames = [
  'अश्विनी','भरणी','कृत्तिका','रोहिणी','मृगशीर्ष','आर्द्रा','पुनर्वसु','पुष्य','आश्रेषा','मघा','पूर्वफल्गुनी',
  'उत्तरफल्गुनी','हस्त','चित्रा','स्वाति','विशाखा','अनूराधा','ज्येष्ठा','मूला','पूर्वाषाढा','उत्तराषाढा','श्रवण',
  'शतभिषा','भव','शिव','सिद्ध','व्याघ्र'
];

function computeNakshatra(moonLon){
  const index = Math.floor(moonLon / (360/27));
  return { index: index, name: nakshatraNames[index] || 'नक्षत्र' };
}

function computeYoga(sunLon, moonLon){
  const sum = norm(sunLon + moonLon);
  const idx = Math.floor(sum / (360/27));
  return { index: idx + 1 };
}

function computeKaran(tithiIdx){
  // simplified karan names (approx)
  const karanNames = ['वणिज','बालव','कौलव','तैतिल','गर','विष्ट','बव','बालव2','तिक','बव2','वणिज2'];
  const half = (tithiIdx - 1) * 2; // 0-based half-tithi
  return { name: karanNames[half % karanNames.length] };
}

/* ---------- Rashi (zodiac sign) ---------- */
const rashiNames = ['मेष','वृषभ','मिथुन','कर्क','सिंह','कन्या','तुला','वृश्चिक','धनु','मकर','कुम्भ','मीन'];
function computeRashi(lon){
  const idx = Math.floor(lon / 30) % 12;
  return rashiNames[idx];
}

/* ---------- Sunrise/Sunset (approx) ---------- */
function sunTimes(dateLocal, lat, lng){
  // dateLocal: local date object at midnight local
  const midnightUTC = new Date(Date.UTC(dateLocal.getFullYear(), dateLocal.getMonth(), dateLocal.getDate(), 0, 0, 0));
  function sunAltitudeAt(timeUTC){
    const jd = dateToJulianDate(timeUTC);
    const sunLon = sunEclipticLongitudeJDE(jd);
    const eps = 23.4397;
    const lam = toRad(sunLon);
    const epsr = toRad(eps);
    const sinBeta = 0;
    const X = Math.cos(lam);
    const Y = Math.cos(epsr)*Math.sin(lam) - Math.sin(epsr)*sinBeta;
    const Z = Math.sin(epsr)*Math.sin(lam) + Math.cos(epsr)*sinBeta;
    const r = Math.sqrt(X*X + Y*Y + Z*Z);
    const dec = Math.asin(Z/r);
    const d = jd - 2451545.0;
    const GMST = norm(280.46061837 + 360.98564736629 * d);
    const LST = norm(GMST + lng);
    const ra = Math.atan2(Y, X);
    let raDeg = toDeg(ra);
    raDeg = norm(raDeg);
    const HA = toRad(LST - raDeg);
    const latr = toRad(lat);
    const alt = Math.asin(Math.sin(latr)*Math.sin(dec) + Math.cos(latr)*Math.cos(dec)*Math.cos(HA));
    return toDeg(alt);
  }

  const step = 5; // minutes
  let times = [];
  let altPrev = sunAltitudeAt(new Date(midnightUTC.getTime()));
  let tPrev = midnightUTC.getTime();
  for(let m=1; m<=288; m++){
    const t = midnightUTC.getTime() + m*step*60000;
    const alt = sunAltitudeAt(new Date(t));
    if((altPrev < -0.833 && alt >= -0.833) || (altPrev >= -0.833 && alt < -0.833)){
      const frac = ( -0.833 - altPrev ) / (alt - altPrev || 1e-6);
      const tCross = new Date(tPrev + frac * (t - tPrev));
      times.push(tCross);
    }
    altPrev = alt; tPrev = t;
  }

  function toLocalTimeString(dtUTC){
    // convert UTC time to local time using browser TZ
    const local = new Date(dtUTC.getTime() + (new Date().getTimezoneOffset()*-1)*60000);
    const hh = String(local.getHours()).padStart(2,'0');
    const mm = String(local.getMinutes()).padStart(2,'0');
    return `${hh}:${mm}`;
  }

  let sunrise = '—', sunset='—';
  if(times.length >= 2){
    sunrise = toLocalTimeString(times[0]);
    sunset = toLocalTimeString(times[1]);
  } else {
    sunrise = '06:00'; sunset='17:45';
  }
  return { sunrise, sunset };
}

/* ---------- Rahu kaal (approx table) ---------- */
const rahuTableDefault = {
  'Mumbai':['16:30-18:00','13:30-15:00','07:30-09:00','10:30-12:00','12:00-13:30','09:00-10:30','15:00-16:30'],
  'Pune' :['16:30-18:00','13:30-15:00','07:30-09:00','10:30-12:00','12:00-13:30','09:00-10:30','15:00-16:30'],
  'Nagpur':['16:00-17:30','13:00-14:30','07:00-08:30','10:00-11:30','11:30-13:00','08:30-10:00','14:00-15:30'],
  'Aurangabad':['16:20-17:50','13:20-14:50','07:20-08:50','10:20-11:50','11:50-13:20','08:50-10:20','14:50-16:20']
};

/* ---------- Compute panchang for a date ---------- */
function computePanchangForDate(dateStr, cityName, lat, lng){
  const parts = dateStr.split('-').map(Number);
  const localMidnight = new Date(parts[0], parts[1]-1, parts[2], 0, 0, 0);
  const jd = dateToJulianDate(new Date(localMidnight.getTime() - localMidnight.getTimezoneOffset()*60000));
  const sunLon = sunEclipticLongitudeJDE(jd + 0.5);
  const moonLon = moonEclipticLongitudeJDE(jd + 0.5);

  const tithi = computeTithi(sunLon, moonLon);
  const nak = computeNakshatra(moonLon);
  const yoga = computeYoga(sunLon, moonLon);
  const sunRashi = computeRashi(sunLon);
  const moonRashi = computeRashi(moonLon);
  const kar = computeKaran(tithi.index);

  const times = sunTimes(localMidnight, lat, lng);
  const rahuArr = (rahuTableDefault[cityName] || rahuTableDefault['Mumbai']);
  const rahu = rahuArr[new Date(localMidnight).getDay()];

  return {
    date: dateStr,
    tithi: `${tithi.index}. ${tithiNames[tithi.nameIndex % tithiNames.length] || 'तिथी'}`,
    tithi_index: tithi.index,
    tithi_end: '',
    nakshatra: `${nak.name}`,
    nakshatra_index: nak.index,
    nak_end: '',
    yoga_index: yoga.index,
    karan: kar.name || '',
    sunr: times.sunrise,
    suns: times.sunset,
    chandra: moonRashi,
    surya: sunRashi,
    guru: sunRashi,
    rahu: rahu
  };
}

/* ---------- UI & Canvas ---------- */
const el = id => document.getElementById(id);
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }
el('dateInput').value = todayISO();

let userImgData = null;
el('userPhoto').addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f){ userImgData = null; return; }
  const r = new FileReader();
  r.onload = ()=> userImgData = r.result;
  r.readAsDataURL(f);
});

function cityLatLng(city){
  const map = {
    'Mumbai':[19.0760,72.8777],
    'Pune':[18.5204,73.8567],
    'Nagpur':[21.1458,79.0882],
    'Aurangabad':[19.8762,75.3433]
  };
  return map[city] || map['Mumbai'];
}

function renderCard(){
  const city = el('city').value;
  const date = el('dateInput').value;
  const name = el('username').value || '';
  const mobile = el('mobile').value || '';
  const [lat, lng] = cityLatLng(city);

  const p = computePanchangForDate(date, city, lat, lng);

  const c = el('canvas'), ctx = c.getContext('2d');
  // background
  ctx.fillStyle = '#fffaf3'; ctx.fillRect(0,0,c.width,c.height);

  // header band
  ctx.fillStyle = '#012b46'; ctx.fillRect(0,0,c.width,120);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 56px Baloo 2, Noto Sans Devanagari'; ctx.textAlign='left';
  ctx.fillText('आजचा पंचांग', 48, 78);

  // date right (marathi format)
  try{
    const dt = new Date(date);
    const dateText = dt.toLocaleDateString('mr-IN', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    ctx.font = '18px Noto Sans Devanagari';
    ctx.fillText(dateText, c.width - 420, 40);
  }catch(e){
    ctx.font = '18px Noto Sans Devanagari';
    ctx.fillText(date, c.width - 180, 40);
  }

  // main card box (outline)
  const boxX = 48, boxY = 150, boxW = c.width - 96;
  ctx.strokeStyle = '#c86d22'; ctx.lineWidth = 5;
  function roundRectDraw(x,y,w,h,r){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); ctx.stroke(); }
  roundRectDraw(boxX, boxY, boxW, 520, 12);

  // left column (card rows)
  ctx.font = '28px Noto Sans Devanagari'; ctx.fillStyle='#0b2b3a'; ctx.textAlign='left';
  let y = boxY + 60; const gap = 60; const textX = boxX + 90;
  function drawIcon(x,y,glyph){ ctx.save(); ctx.fillStyle='#f9c846'; ctx.beginPath(); ctx.arc(x,y,22,0,Math.PI*2); ctx.fill(); ctx.fillStyle='#fff'; ctx.font='18px Noto Sans Devanagari'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(glyph,x,y); ctx.restore(); }

  drawIcon(boxX+36, y-10, 'ति'); ctx.fillText(`तिथी: ${p.tithi}${p.tithi_end?(' • समाप्ती: '+p.tithi_end):''}`, textX, y); y+=gap;
  drawIcon(boxX+36, y-10, 'वा'); ctx.fillText(`वार: ${new Date(date).toLocaleDateString('mr-IN',{weekday:'long'})}`, textX, y); y+=gap;
  drawIcon(boxX+36, y-10, 'न'); ctx.fillText(`नक्षत्र: ${p.nakshatra}${p.nak_end?(' • समाप्ती: '+p.nak_end):''}`, textX, y); y+=gap;
  drawIcon(boxX+36, y-10, 'यो'); ctx.fillText(`योग: ${p.yoga_index?('योग-'+p.yoga_index):'—'}`, textX, y); y+=gap;
  drawIcon(boxX+36, y-10, 'क'); ctx.fillText(`करण: ${p.karan}`, textX, y); y+=gap;

  // right column
  const col2X = boxX + Math.floor(boxW/2) + 20; let y2 = boxY + 60;
  ctx.font = '26px Noto Sans Devanagari';
  ctx.fillText(`सूर्योदय: ${p.sunr}    सूर्यास्त: ${p.suns}`, col2X, y2); y2+=48;
  ctx.fillText(`चंद्रराशी: ${p.chandra}`, col2X, y2); y2+=48;
  ctx.fillText(`सूर्यराशी: ${p.surya}`, col2X, y2); y2+=48;
  ctx.fillText(`गुरु राशि: ${p.guru}`, col2X, y2); y2+=48;
  ctx.fillText(`राहू काल: ${p.rahu}`, col2X, y2); y2+=48;

  // bottom strip user info
  const stripY = boxY + 520 + 40;
  ctx.fillStyle = '#083b52'; ctx.fillRect(0, stripY, c.width, 140);
  ctx.fillStyle = '#fff'; ctx.font = 'bold 34px Noto Sans Devanagari'; ctx.textAlign='left';
  ctx.fillText(name || '', 48, stripY + 48);
  ctx.font = '22px Noto Sans Devanagari'; ctx.fillText(`संपर्क: ${mobile || ''}`, 48, stripY + 88);

  // avatar
  if(userImgData){
    const img = new Image();
    img.onload = ()=>{
      ctx.save(); ctx.beginPath();
      ctx.arc(c.width - 120, stripY + 70, 56, 0, Math.PI*2); ctx.closePath(); ctx.clip();
      ctx.drawImage(img, c.width - 176, stripY + 14, 112, 112); ctx.restore();
      finalize();
    };
    img.onerror = ()=> finalize();
    img.src = userImgData;
  } else finalize();

  function finalize(){
    ctx.font = '14px Noto Sans Devanagari'; ctx.fillStyle='rgba(0,0,0,0.35)'; ctx.textAlign='right';
    ctx.fillText('OmKarmyog', c.width - 24, c.height - 12);
    try{
      el('preview').src = c.toDataURL('image/png');
    }catch(e){
      console.error(e);
      el('preview').alt = 'Preview not supported';
    }
  }
}

/* Attach events */
el('generateBtn').addEventListener('click', renderCard);
el('downloadBtn').addEventListener('click', ()=>{
  try{
    const a = document.createElement('a'); a.href = el('canvas').toDataURL('image/png'); a.download = 'panchang_1080x1316.png'; a.click();
  }catch(e){ alert('Download not supported: '+e.message); }
});

/* Auto-run on load */
window.addEventListener('load', ()=> setTimeout(()=> { try{ renderCard(); }catch(e){ console.warn(e); } }, 400));
</script>
</body>
</html>
